rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* Helpers */
    function isSignedIn() {
      return request.auth != null;
    }
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.role == 'admin' ||
        request.auth.token.admin == true
      );
    }

    /* Catálogo / Site */
    match /projects/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /site/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* Pedidos */
    match /orders/{orderId} {
      // Leitura: dono do doc ou admin
      allow read: if isAdmin() ||
        (isSignedIn() && resource.data.customerUid == request.auth.uid);

      // Escrita: só admin (backend com Admin SDK ignora regras)
      allow create, update, delete: if isAdmin();
    }

    /* Perfil do usuário */
    match /users/{uid} {
      allow read, write: if isSignedIn() && request.auth.uid == uid;
    }

    /* Nega o restante */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
